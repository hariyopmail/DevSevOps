#!/bin/sh

SAMBA=$(rpm -q samba >/dev/null 2>&1; echo $?)
SAMBA3=$(rpm -q samba3x >/dev/null 2>&1; echo $?)
SAMBA4=$(rpm -q samba4 >/dev/null 2>&1; echo $?)
RHEL5=$(grep -qi "release 5" /etc/redhat-release; echo $?)
RHEL4=$(grep -qi "release 4" /etc/redhat-release; echo $?)
AFFECTED=0
UPDATED=0

if [ ${SAMBA3} == "0" ] ; then
     if [ "$(rpm -q --changelog samba3x | grep -q CVE-2015-0240; echo $?)" == "1" ]; then
         echo "A vulnerable samba3x is installed!  Please see https://access.redhat.com/articles/1346913 for instructions to upgrade to a newer version."
         AFFECTED=1
     else
         echo "You have installed the patched samba updates."
         UPDATED=1
     fi
fi

if [ ${SAMBA4} == "0" ]; then
     if [ "$(rpm -q --changelog samba4 | grep -q CVE-2015-0240; echo $?)" == "1" ]; then
         echo "A vulnerable samba4 is installed!  Please see https://access.redhat.com/articles/1346913 for instructions to upgrade to a newer version."
         AFFECTED=1
     else
         echo "You have installed the patched samba updates."
         UPDATED=1
     fi
fi

if [ ${SAMBA} == "0" ] && [ ${RHEL5} == "1" ] && [ ${RHEL4} == "1" ]; then
     if [ "$(rpm -q --changelog samba | grep -q CVE-2015-0240; echo $?)" == "1" ]; then
        echo "A vulnerable samba is installed!  Please see https://access.redhat.com/articles/1346913 for instructions to upgrade to a newer version."
        AFFECTED=1
     else
        echo "You have installed the patched samba updates."
        UPDATED=1
     fi
elif [ ${SAMBA} == "0" ] && [ ${RHEL5} == "0" ]; then
    echo "The installed 'samba' package on Red Hat Enterprise Linux 5 is not affected by this flaw."
elif [ ${SAMBA} == "0" ] && [ ${RHEL4} == "0" ]; then
    echo "The installed 'samba' package on Red Hat Enterprise Linux 4 is not affected by this flaw."
fi

if [ ${AFFECTED} == "0" ]; then
    echo "No vulnerable packages installed!"
elif [ ${UPDATED} == "1" ]; then
    echo "You have installed the patched samba update(s)."
fi
